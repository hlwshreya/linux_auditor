---
# roles/oscap_remediation/tasks/apply_remediation.yml

- name: Create backup of important configuration files
  block:
    - name: Create backup directory with timestamp
      file:
        path: "/var/backups/oscap-remediation/{{ remediation_timestamp }}"
        state: directory
        mode: '0700'

    - name: Backup SSH configuration
      copy:
        src: "/etc/ssh/sshd_config"
        dest: "/var/backups/oscap-remediation/{{ remediation_timestamp }}/sshd_config"
        remote_src: yes
      failed_when: false

    - name: Backup security limits
      copy:
        src: "/etc/security/limits.conf"
        dest: "/var/backups/oscap-remediation/{{ remediation_timestamp }}/limits.conf"
        remote_src: yes
      failed_when: false

    - name: Backup PAM configuration directory
      shell: cp -r /etc/pam.d /var/backups/oscap-remediation/{{ remediation_timestamp }}/pam.d
      args:
        executable: /bin/bash
      failed_when: false

    - name: Backup sysctl configuration
      copy:
        src: "/etc/sysctl.conf"
        dest: "/var/backups/oscap-remediation/{{ remediation_timestamp }}/sysctl.conf"
        remote_src: yes
      failed_when: false

    - name: Display backup location
      debug:
        msg: "Configuration backups saved to /var/backups/oscap-remediation/{{ remediation_timestamp }}"
  when: backup_before_remediate | default(true) | bool

- name: Apply remediation playbook
  shell: |
    ansible-playbook {{ remediation_playbook }}
  args:
    executable: /bin/bash
  delegate_to: localhost
  register: remediation_result
  ignore_errors: yes

- name: Display remediation execution summary
  debug:
    msg:
      - "=========================================="
      - "Remediation execution completed"
      - "=========================================="
      - "Status: {{ 'SUCCESS' if remediation_result.rc == 0 else 'FAILED' }}"
      - "Backup location: /var/backups/oscap-remediation/{{ remediation_timestamp }}"
      - ""
      - "Next steps:"
      - "  1. Verify system is functioning properly"
      - "  2. Re-run oscap_scan role to verify compliance"
      - "  3. Check /var/log for any service warnings"
